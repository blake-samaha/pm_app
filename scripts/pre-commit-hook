#!/usr/bin/env bash
# Robust pre-commit hook that works with uv and various environments
# This hook is designed to work whether or not the virtualenv is activated,
# making it compatible with IDE git integrations (Cursor, VS Code, etc.)

set -e

HERE="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$HERE/../.." && pwd)"
BACKEND_VENV="$REPO_ROOT/backend/.venv/bin/python"

# Try multiple methods in order of preference:

# 1. Use uv run from the backend directory (works without venv activation)
if command -v uv > /dev/null 2>&1; then
    cd "$REPO_ROOT/backend"
    exec uv run pre-commit hook-impl --config="$REPO_ROOT/.pre-commit-config.yaml" --hook-type=pre-commit --hook-dir "$HERE" -- "$@"
fi

# 2. Use the venv Python directly if it exists
if [ -x "$BACKEND_VENV" ]; then
    exec "$BACKEND_VENV" -mpre_commit hook-impl --config="$REPO_ROOT/.pre-commit-config.yaml" --hook-type=pre-commit --hook-dir "$HERE" -- "$@"
fi

# 3. Use global pre-commit if available
if command -v pre-commit > /dev/null 2>&1; then
    exec pre-commit hook-impl --config="$REPO_ROOT/.pre-commit-config.yaml" --hook-type=pre-commit --hook-dir "$HERE" -- "$@"
fi

# 4. If nothing works, provide helpful error
echo "ERROR: Could not find pre-commit. Please install uv or run:" 1>&2
echo "  cd backend && uv sync" 1>&2
exit 1

